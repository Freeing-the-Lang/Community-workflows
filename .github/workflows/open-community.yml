name: ðŸ§© Auto Community Standards + ProofLedger

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  discussions: write

jobs:
  community:
    name: ðŸ“¦ Ensure Community Standards
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§­ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Create Missing Community Files
        shell: bash
        run: |
          mkdir -p .github/ISSUE_TEMPLATE

          echo "ðŸ” Checking community standard files..."

          # README
          if [ ! -f README.md ]; then
            echo "# Freeing-the-Lang" > README.md
            echo "Language unification ecosystem â€” automated community compliance." >> README.md
          fi

          # LICENSE
          if [ ! -f LICENSE ]; then
            echo "MIT License" > LICENSE
            echo "Copyright (c) $(date +%Y) Freeing-the-Lang" >> LICENSE
          fi

          # Code of Conduct
          if [ ! -f CODE_OF_CONDUCT.md ]; then
            cat > CODE_OF_CONDUCT.md <<'EOF'
# Code of Conduct
We follow the Contributor Covenant Code of Conduct.

- Be respectful and constructive.
- No harassment or hate speech.
- Collaborate openly and fairly.
EOF
          fi

          # Contributing
          if [ ! -f CONTRIBUTING.md ]; then
            cat > CONTRIBUTING.md <<'EOF'
# Contributing
1. Fork and branch.
2. Commit cleanly with clear messages.
3. All pushes automatically create ProofLedger and Discussions.
EOF
          fi

          # Security Policy
          if [ ! -f SECURITY.md ]; then
            cat > SECURITY.md <<'EOF'
# Security Policy
If you discover a vulnerability, please open a private Issue or email the maintainers.
We respond within 48 hours.
EOF
          fi

          # Issue Template
          if [ ! -f .github/ISSUE_TEMPLATE/bug_report.md ]; then
            cat > .github/ISSUE_TEMPLATE/bug_report.md <<'EOF'
---
name: ðŸž Bug Report
about: Report a problem
labels: bug
---

### Description
A clear description of the issue.

### Steps to Reproduce
1. 
2. 
3. 

### Expected Behavior
Describe what you expected to happen.
EOF
          fi

          # PR Template
          if [ ! -f .github/PULL_REQUEST_TEMPLATE.md ]; then
            cat > .github/PULL_REQUEST_TEMPLATE.md <<'EOF'
# ðŸ§© Pull Request
## Summary
## Related Issue
- [ ] Build successful
- [ ] ProofLedger updated
- [ ] Discussion/Issue linked
EOF
          fi

          echo "âœ… All community standard files verified or created."

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md LICENSE CODE_OF_CONDUCT.md CONTRIBUTING.md SECURITY.md .github
          git commit -m "ðŸ§© Auto ensure community standard files" || echo "No changes to commit"
          git push origin main || echo "Push skipped."

  proofledger:
    name: ðŸ§¾ Update ProofLedger
    runs-on: ubuntu-latest
    needs: community
    steps:
      - name: ðŸ§­ Checkout Repository
        uses: actions/checkout@v4
      - name: ðŸ”’ Append ledger
        shell: bash
        run: |
          mkdir -p proofledger
          echo "ðŸ§¾ Generating ProofLedger..."
          {
            echo "Commit SHA: $GITHUB_SHA"
            echo "Author: $GITHUB_ACTOR"
            echo "Repo: $GITHUB_REPOSITORY"
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "SHA256: $(git rev-parse HEAD | sha256sum | cut -d' ' -f1)"
            echo "--------------------------------------"
          } >> proofledger/proofledger.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add proofledger/proofledger.txt
          git commit -m "ðŸ”’ Update ProofLedger for $GITHUB_SHA" || echo "No new ledger entry"
          git push origin main || echo "Push skipped."
