name: üåç Open Community + ProofLedger + Auto Discussion Enable

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  discussions: write
  administration: write

jobs:
  community:
    name: üì¶ Ensure Community Standards
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: üèóÔ∏è Create Missing Community Files
        shell: bash
        run: |
          mkdir -p .github/ISSUE_TEMPLATE
          echo "üîç Checking community standard files..."

          if [ ! -f README.md ]; then
            echo "# Freeing-the-Lang" > README.md
            echo "Language unification ecosystem ‚Äî automated community setup." >> README.md
          fi

          if [ ! -f LICENSE ]; then
            echo "MIT License" > LICENSE
            echo "Copyright (c) $(date +%Y) Freeing-the-Lang" >> LICENSE
          fi

          if [ ! -f CODE_OF_CONDUCT.md ]; then
cat > CODE_OF_CONDUCT.md <<'EOF'
# Code of Conduct
We follow the Contributor Covenant Code of Conduct.
- Be respectful and constructive.
- No harassment or hate speech.
- Collaborate openly and fairly.
EOF
          fi

          if [ ! -f CONTRIBUTING.md ]; then
cat > CONTRIBUTING.md <<'EOF'
# Contributing
1. Fork and branch.
2. Commit clearly.
3. All pushes automatically update ProofLedger and Discussions.
EOF
          fi

          if [ ! -f SECURITY.md ]; then
cat > SECURITY.md <<'EOF'
# Security Policy
Report vulnerabilities privately.
Response target: within 48 hours.
EOF
          fi

          if [ ! -f .github/ISSUE_TEMPLATE/bug_report.md ]; then
cat > .github/ISSUE_TEMPLATE/bug_report.md <<'EOF'
---
name: üêû Bug Report
about: Report a problem
labels: bug
---
### Description
Describe the issue.
### Steps to Reproduce
1.
2.
3.
### Expected Behavior
Describe what you expected.
EOF
          fi

          if [ ! -f .github/PULL_REQUEST_TEMPLATE.md ]; then
cat > .github/PULL_REQUEST_TEMPLATE.md <<'EOF'
# üß© Pull Request
## Summary
## Related Issue
- [ ] Build successful
- [ ] ProofLedger updated
- [ ] Linked Discussions/Issues
EOF
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md LICENSE CODE_OF_CONDUCT.md CONTRIBUTING.md SECURITY.md .github
          git commit -m "üß© Auto ensure community standard files" || echo "No changes"
          git push origin main || echo "Push skipped"

  proofledger:
    name: üßæ ProofLedger Update
    runs-on: ubuntu-latest
    needs: community
    steps:
      - uses: actions/checkout@v4
      - name: üîí Append ProofLedger Entry
        shell: bash
        run: |
          mkdir -p proofledger
          {
            echo "Commit SHA: $GITHUB_SHA"
            echo "Author: $GITHUB_ACTOR"
            echo "Repository: $GITHUB_REPOSITORY"
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "SHA256: $(git rev-parse HEAD | sha256sum | cut -d' ' -f1)"
            echo "--------------------------------------"
          } >> proofledger/proofledger.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add proofledger/proofledger.txt
          git commit -m "üîí Update ProofLedger for $GITHUB_SHA" || echo "No new ledger entry"
          git push origin main || echo "Push skipped"

  enable-discussions:
    name: ‚öôÔ∏è Enable Discussions Automatically
    runs-on: ubuntu-latest
    needs: proofledger
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split("/");
            console.log("üîß Enabling Discussions feature if disabled...");
            await github.request("PATCH /repos/{owner}/{repo}", {
              owner,
              repo,
              has_discussions: true
            });
            console.log("‚úÖ Discussions feature is enabled.");

            console.log("üîé Checking for 'General' category...");
            const repoData = await github.graphql(`
              query($owner:String!, $repo:String!){
                repository(owner:$owner, name:$repo){
                  id
                  discussionCategories(first:10){nodes{id name}}
                }
              }`,
              { owner, repo }
            );

            const general = repoData.repository.discussionCategories.nodes.find(c => c.name === "General");
            if (general) {
              console.log("‚úÖ 'General' category exists.");
            } else {
              console.log("‚ûï Creating 'General' category...");
              const createCat = await github.graphql(`
                mutation($repoId:ID!){
                  createDiscussionCategory(input:{
                    repositoryId:$repoId,
                    name:"General",
                    description:"General discussion topics"
                  }){discussionCategory{id name}}
                }`, { repoId: repoData.repository.id });
              console.log("‚úÖ Created:", createCat.createDiscussionCategory.discussionCategory.name);
            }

  discussion:
    name: üí¨ Create Discussion for Commit
    runs-on: ubuntu-latest
    needs: enable-discussions
    steps:
      - uses: actions/checkout@v4
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split("/");
            const repoInfo = await github.graphql(`
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  id
                  discussionCategories(first: 10) { nodes { id name } }
                }
              }
            `, { owner, repo });
            const category = repoInfo.repository.discussionCategories.nodes.find(c => c.name === "General");
            const title = `üó£Ô∏è Commit Discussion ‚Äî ${process.env.GITHUB_SHA.slice(0,7)}`;
            const body = [
              `Commit pushed by @${process.env.GITHUB_ACTOR}`,
              `Repository: ${process.env.GITHUB_REPOSITORY}`,
              `SHA: ${process.env.GITHUB_SHA}`,
              `Timestamp: ${new Date().toISOString()}`
            ].join("\n\n");
            const result = await github.graphql(`
              mutation($repoId: ID!, $catId: ID!, $title: String!, $body: String!) {
                createDiscussion(input:{
                  repositoryId:$repoId,
                  categoryId:$catId,
                  title:$title,
                  body:$body
                }){discussion{url}}
              }`,
              { repoId: repoInfo.repository.id, catId: category.id, title, body }
            );
            console.log("‚úÖ Discussion created:", result.createDiscussion.discussion.url);

  issue:
    name: ü™∂ Auto Create Issue
    runs-on: ubuntu-latest
    needs: discussion
    steps:
      - uses: actions/checkout@v4
      - uses: peter-evans/create-issue-from-file@v4
        with:
          title: "üöÄ Auto Update ‚Äî ${{ github.event.head_commit.message }}"
          content-filepath: .github/ISSUE_TEMPLATE/bug_report.md
          labels: |
            automation
            proofledger
          assignees: ${{ github.actor }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
