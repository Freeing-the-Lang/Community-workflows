name: ğŸŒ Open Community + ProofLedger + Auto Discussion Enable

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  discussions: write
  issues: write

jobs:
  # 1. ì»¤ë®¤ë‹ˆí‹° í‘œì¤€ íŒŒì¼(README, LICENSE ë“±) ìë™ ìƒì„± ë° í™•ì¸
  community:
    name: ğŸ“¦ Ensure Community Standards
    runs-on: ubuntu-latest
    # ğŸš¨ ë´‡ì´ ë§Œë“  ì»¤ë°‹ì— ì˜í•´ ë¬´í•œ ë£¨í”„ê°€ ë„ëŠ” ê²ƒì„ ë°©ì§€
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ—ï¸ Create Missing Community Files
        shell: bash
        run: |
          mkdir -p .github/ISSUE_TEMPLATE
          echo "ğŸ” ì»¤ë®¤ë‹ˆí‹° í‘œì¤€ íŒŒì¼ í™•ì¸ ì¤‘..."

          # --- README (ì—†ìœ¼ë©´ ìƒì„±) ---
          if [ ! -f README.md ]; then
            echo "# Freeing-the-Lang" > README.md
            echo "Language unification ecosystem â€” automated community setup." >> README.md
          fi

          # --- LICENSE (MIT) ---
          if [ ! -f LICENSE ]; then
            echo "MIT License" > LICENSE
            echo "Copyright (c) $(date +%Y) Freeing-the-Lang" >> LICENSE
          fi

          # --- CODE OF CONDUCT ---
          if [ ! -f CODE_OF_CONDUCT.md ]; then
            printf "# Code of Conduct\nWe follow the Contributor Covenant Code of Conduct.\n- Be respectful and constructive.\n- No harassment or hate speech.\n- Collaborate openly and fairly.\n" > CODE_OF_CONDUCT.md
          fi

          # --- CONTRIBUTING ---
          if [ ! -f CONTRIBUTING.md ]; then
            printf "# Contributing\n1. Fork and branch.\n2. Commit clearly.\n3. All pushes automatically update ProofLedger and Discussions.\n" > CONTRIBUTING.md
          fi

          # --- SECURITY ---
          if [ ! -f SECURITY.md ]; then
            printf "# Security Policy\nReport vulnerabilities privately.\nResponse target: within 48 hours.\n" > SECURITY.md
          fi

          # --- BUG REPORT TEMPLATE ---
          if [ ! -f .github/ISSUE_TEMPLATE/bug_report.md ]; then
            printf -- "---\nname: ğŸ Bug Report\nabout: Report a problem\nlabels: bug\n---\n### Description\nDescribe the issue.\n### Steps to Reproduce\n1.\n2.\n3.\n### Expected Behavior\nDescribe what you expected.\n" > .github/ISSUE_TEMPLATE/bug_report.md
          fi

          # --- PR TEMPLATE ---
          if [ ! -f .github/PULL_REQUEST_TEMPLATE.md ]; then
            printf "# ğŸ§© Pull Request\n## Summary\n## Related Issue\n- [ ] Build successful\n- [ ] ProofLedger updated\n- [ ] Linked Discussions/Issues\n" > .github/PULL_REQUEST_TEMPLATE.md
          fi

          # --- ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ ---
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md LICENSE CODE_OF_CONDUCT.md CONTRIBUTING.md SECURITY.md .github
          # ë³€ê²½ ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹
          git diff --staged --quiet || git commit -m "chore: ğŸ§© Auto ensure community standard files"
          git push origin main || echo "Nothing to push"

  # 2. ëª¨ë“  ì»¤ë°‹ì„ ProofLedgerì— ì˜êµ¬ ê¸°ë¡
  proofledger:
    name: ğŸ§¾ ProofLedger Update
    runs-on: ubuntu-latest
    needs: community
    # ë´‡ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ”’ Append ProofLedger Entry
        shell: bash
        run: |
          mkdir -p proofledger
          # ë¡œê·¸ ì—”íŠ¸ë¦¬ ìƒì„±
          {
            echo "Commit SHA: $GITHUB_SHA"
            echo "Author: $GITHUB_ACTOR"
            echo "Repository: $GITHUB_REPOSITORY"
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "SHA256: $(git rev-parse HEAD | sha256sum | cut -d' ' -f1)"
            echo "--------------------------------------"
          } >> proofledger/proofledger.txt
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add proofledger/proofledger.txt
          git commit -m "chore: ğŸ”’ Update ProofLedger for $GITHUB_SHA" || echo "No new ledger entry"
          git push origin main || echo "Push skipped"

  # 3. ë¦¬í¬ì§€í† ë¦¬ì˜ Discussions ê¸°ëŠ¥ í™œì„±í™” ë° ì¹´í…Œê³ ë¦¬ ìƒì„±
  enable-discussions:
    name: âš™ï¸ Enable Discussions Automatically
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split("/");
            console.log("ğŸ”§ Discussions ê¸°ëŠ¥ í™œì„±í™” í™•ì¸ ì¤‘...");
            try {
              // ì¼ë¶€ ê¶Œí•œ ì„¤ì •ì— ë”°ë¼ 403 ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆìœ¼ë‚˜ ì‹œë„í•¨
              await github.request("PATCH /repos/{owner}/{repo}", {
                owner,
                repo,
                has_discussions: true
              });
              console.log("âœ… Discussions ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (e) {
              console.error("âš ï¸ ìë™ í™œì„±í™” ì‹¤íŒ¨ (í† í° ê¶Œí•œ ë¶€ì¡± ê°€ëŠ¥ì„±). Repo Settingsì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì¼œì£¼ì„¸ìš”.", e.message);
            }
            
            // 'General' ì¹´í…Œê³ ë¦¬ í™•ì¸ ë° ìƒì„±
            const repoData = await github.graphql(`
              query($owner:String!, $repo:String!){
                repository(owner:$owner, name:$repo){
                  id
                  discussionCategories(first:10){nodes{id name}}
                }
              }`,
              { owner, repo }
            );

            const general = repoData.repository.discussionCategories.nodes.find(c => c.name === "General");
            if (general) {
              console.log("âœ… 'General' ì¹´í…Œê³ ë¦¬ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.");
            } else {
              console.log("â• 'General' ì¹´í…Œê³ ë¦¬ ìƒì„± ì¤‘...");
              try {
                const createCat = await github.graphql(`
                  mutation($repoId:ID!){
                    createDiscussionCategory(input:{
                      repositoryId:$repoId,
                      name:"General",
                      description:"General discussion topics"
                    }){discussionCategory{id name}}
                  }`, { repoId: repoData.repository.id });
                console.log("âœ… ìƒì„± ì™„ë£Œ:", createCat.createDiscussionCategory.discussionCategory.name);
              } catch (e) {
                 console.error("ì¹´í…Œê³ ë¦¬ ìƒì„± ì‹¤íŒ¨.", e.message);
              }
            }

  # 4. ì»¤ë°‹ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìƒˆ Discussion ìƒì„±
  discussion:
    name: ğŸ’¬ Create Discussion for Commit
    runs-on: ubuntu-latest
    needs: enable-discussions
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split("/");
            const repoInfo = await github.graphql(`
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  id
                  discussionCategories(first: 10) { nodes { id name } }
                }
              }
            `, { owner, repo });
            
            const category = repoInfo.repository.discussionCategories.nodes.find(c => c.name === "General");
            if (!category) {
              console.log("âŒ General ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ í† ë¡  ìƒì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
              return;
            }

            const title = `ğŸ—£ï¸ Commit Discussion â€” ${process.env.GITHUB_SHA.slice(0,7)}`;
            const body = [
              `A new commit was pushed by @${process.env.GITHUB_ACTOR}.`,
              `**Repository:** ${process.env.GITHUB_REPOSITORY}`,
              `**Commit:** ${process.env.GITHUB_SHA}`,
              `**Message:** \`\`\`${process.env.GITHUB_EVENT_PATH ? (await require('fs').promises.readFile(process.env.GITHUB_EVENT_PATH, 'utf8').then(data => JSON.parse(data).head_commit.message)) : 'N/A'}\`\`\``
            ].join("\n\n");
            
            const result = await github.graphql(`
              mutation($repoId: ID!, $catId: ID!, $title: String!, $body: String!) {
                createDiscussion(input:{
                  repositoryId:$repoId,
                  categoryId:$catId,
                  title:$title,
                  body:$body
                }){discussion{url}}
              }`,
              { repoId: repoInfo.repository.id, catId: category.id, title, body }
            );
            console.log("âœ… Discussion ìƒì„±ë¨:", result.createDiscussion.discussion.url);

  # 5. ì´ìŠˆ ìƒì„± ë° ì»¤ë°‹ ì‘ì„±ì ìë™ í• ë‹¹ (Auto Assign)
  issue:
    name: ğŸª¶ Auto Create Issue & Assign
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: ğŸš€ Create Issue for Commit
        uses: peter-evans/create-issue@v5
        with:
          title: "ğŸš€ Auto Update â€” ${{ github.event.head_commit.message }}"
          body: |
            A new commit was pushed to `main` by @${{ github.actor }}.
            
            **Commit:** `${{ github.sha }}`
            **Message:** `${{ github.event.head_commit.message }}`
            
            This issue was auto-generated for tracking and proof-of-work.
          labels: |
            automation
            proofledger
          # ğŸ‘‡ ì»¤ë°‹ ì‘ì„±ìë¥¼ ë‹´ë‹¹ìë¡œ ìë™ ì§€ì •
          assignees: ${{ github.actor }}
