name: üåç Full Community Compliance + ProofLedger Automation

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  discussions: write

jobs:
  community-standards:
    name: üß© Ensure Community Standards
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ‚öôÔ∏è Ensure basic community files exist
        shell: bash
        run: |
          mkdir -p .github/ISSUE_TEMPLATE
          echo "‚úÖ Checking for community standard files..."

          # README
          if [ ! -f README.md ]; then
            echo "# Freeing-the-Lang" > README.md
            echo "Experimental multi-language ecosystem ‚Äî automatic community setup." >> README.md
            echo "üß± Auto-generated README"
          fi

          # LICENSE
          if [ ! -f LICENSE ]; then
            echo "MIT License" > LICENSE
            echo "Copyright (c) $(date +%Y) Freeing-the-Lang" >> LICENSE
          fi

          # CODE_OF_CONDUCT
          if [ ! -f CODE_OF_CONDUCT.md ]; then
            cat > CODE_OF_CONDUCT.md <<'EOF'
# Code of Conduct
We follow the Contributor Covenant Code of Conduct.

- Be respectful and constructive.  
- Focus on collaboration, not competition.  
- No harassment, hate speech, or personal attacks.
EOF
          fi

          # CONTRIBUTING
          if [ ! -f CONTRIBUTING.md ]; then
            cat > CONTRIBUTING.md <<'EOF'
# Contributing to Freeing-the-Lang
1. Fork, branch, commit, and open a PR.
2. All pushes trigger auto Discussions, Issues, and ProofLedger logs.
3. Be respectful and clear in communication.
EOF
          fi

          # SECURITY
          if [ ! -f SECURITY.md ]; then
            cat > SECURITY.md <<'EOF'
# Security Policy
Report vulnerabilities via Issues or private message to maintainers.
We aim to respond within 48 hours.
EOF
          fi

          # ISSUE TEMPLATE
          if [ ! -f .github/ISSUE_TEMPLATE/bug_report.md ]; then
            cat > .github/ISSUE_TEMPLATE/bug_report.md <<'EOF'
---
name: üêû Bug Report
about: Report a problem
labels: bug
---
### Description
### Steps to Reproduce
### Expected Behavior
EOF
          fi

          # PR TEMPLATE
          if [ ! -f .github/PULL_REQUEST_TEMPLATE.md ]; then
            cat > .github/PULL_REQUEST_TEMPLATE.md <<'EOF'
# üß© Pull Request
## Summary
## Related Issue
- [ ] Build successful
- [ ] ProofLedger updated
- [ ] Discussion/Issue linked
EOF
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md LICENSE CODE_OF_CONDUCT.md CONTRIBUTING.md SECURITY.md .github
          git commit -m "üß© Auto ensure community standard files" || echo "No updates needed"
          git push origin main || echo "Push skipped."

  proofledger:
    name: üßæ Generate ProofLedger
    runs-on: ubuntu-latest
    needs: community-standards
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - name: üîí Append ProofLedger entry
        shell: bash
        run: |
          mkdir -p proofledger
          echo "üßæ Recording ProofLedger entry..."
          {
            echo "Commit SHA: $GITHUB_SHA"
            echo "Author: $GITHUB_ACTOR"
            echo "Repository: $GITHUB_REPOSITORY"
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "SHA256: $(git rev-parse HEAD | sha256sum | cut -d' ' -f1)"
            echo "-------------------------------------"
          } >> proofledger/proofledger.txt

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add proofledger/proofledger.txt
          git commit -m "üîí Update ProofLedger for $GITHUB_SHA" || echo "No changes"
          git push origin main || echo "Push skipped."

  create-discussion:
    name: üí¨ Auto Discussion (GraphQL)
    runs-on: ubuntu-latest
    needs: proofledger
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repoInfo = await github.graphql(`
              query {
                repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                  id
                  discussionCategories(first: 10) { nodes { id name } }
                }
              }
            `);
            const repoId = repoInfo.repository.id;
            const category = repoInfo.repository.discussionCategories.nodes.find(c => c.name === "General");
            if (!category) { console.log("‚ö†Ô∏è No 'General' category found."); return; }
            const result = await github.graphql(`
              mutation($repo:ID!,$cat:ID!,$title:String!,$body:String!){
                createDiscussion(input:{
                  repositoryId:$repo,
                  categoryId:$cat,
                  title:$title,
                  body:$body
                }){discussion{url}}
              }`,
              { repo: repoId, cat: category.id, title: `üó£Ô∏è Commit Discussion ‚Äî ${process.env.GITHUB_SHA.slice(0,7)}`, body: `Commit by @${process.env.GITHUB_ACTOR}` }
            );
            console.log("‚úÖ Discussion created:", result.createDiscussion.discussion.url);

  create-issue:
    name: ü™∂ Auto Issue on Push
    runs-on: ubuntu-latest
    needs: create-discussion
    steps:
      - uses: actions/checkout@v4
      - uses: peter-evans/create-issue-from-file@v4
        with:
          title: "üöÄ Auto Update ‚Äî ${{ github.event.head_commit.message }}"
          content-filepath: .github/ISSUE_TEMPLATE/bug_report.md
          labels: |
            automation
            proofledger
          assignees: ${{ github.actor }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto-merge:
    name: ü§ù Auto Merge PRs
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: merge
          MERGE_COMMIT_MESSAGE: "ü§ù Auto-merged PR by ${{ github.actor }}"
