name: üåç Open Community Automation (GraphQL Edition)

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  discussions: write

jobs:
  create-discussion:
    name: üí¨ Auto Create Discussion (GraphQL)
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: üß≠ Checkout Repository
        uses: actions/checkout@v4

      - name: üí≠ Create Discussion using GraphQL
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repoInfo = await github.graphql(`
              query {
                repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                  id
                  discussionCategories(first: 10) {
                    nodes { id name }
                  }
                }
              }
            `);
            const repoId = repoInfo.repository.id;
            const category = repoInfo.repository.discussionCategories.nodes.find(
              c => c.name === "General"
            );
            if (!category) {
              console.log("‚ö†Ô∏è No 'General' category found ‚Äî please create one in Discussions first.");
              return;
            }
            const categoryId = category.id;
            const title = `üó£Ô∏è New Commit Discussion ‚Äî ${process.env.GITHUB_SHA.slice(0, 7)}`;
            const body = `A new commit was pushed by @${process.env.GITHUB_ACTOR}\n\nCommit message:\n${process.env.GITHUB_HEAD_REF || 'Manual Push'}\n\nSHA: ${process.env.GITHUB_SHA}`;
            const mutation = `
              mutation($repoId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
                createDiscussion(input: {
                  repositoryId: $repoId,
                  categoryId: $categoryId,
                  title: $title,
                  body: $body
                }) {
                  discussion { url }
                }
              }
            `;
            const result = await github.graphql(mutation, { repoId, categoryId, title, body });
            console.log("‚úÖ Discussion created:", result.createDiscussion.discussion.url);

  create-issue:
    name: ü™∂ Auto Create Issue on Push
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: üß≠ Checkout Repository
        uses: actions/checkout@v4

      - name: üßæ Create linked issue
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "üöÄ Update Trigger ‚Äî ${{ github.event.head_commit.message }}"
          content-filepath: .github/ISSUE_TEMPLATE/auto.md
          labels: |
            automation
            discussion-link
          assignees: ${{ github.actor }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto-merge:
    name: ü§ù Auto Merge Pull Requests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: üß≠ Checkout Repository
        uses: actions/checkout@v4

      - name: ‚úÖ Auto approve & merge PR
        uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: merge
          MERGE_COMMIT_MESSAGE: "ü§ù Auto-merged PR by ${{ github.actor }}"
